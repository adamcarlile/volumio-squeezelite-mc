{"version":3,"file":"PlayerStatusMonitor.js","sourceRoot":"","sources":["../../src/lib/PlayerStatusMonitor.ts"],"names":[],"mappings":"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","sourcesContent":["import EventEmitter from 'events';\nimport sm from './SqueezeliteMCContext';\nimport { type Notification, NotificationListener } from 'lms-cli-notifications';\nimport {type PlayerStatus} from './types/Player';\nimport type Player from './types/Player';\nimport { type ServerCredentials } from './types/Server';\nimport { getServerConnectParams } from './Util';\nimport { sendRpcRequest } from './RPC';\n\ntype ServerType = 'lms' | 'music-assistant' | 'unknown';\n\nexport default class PlayerStatusMonitor extends EventEmitter {\n  #player: Player;\n  #serverCredentials: ServerCredentials;\n  #notificationListener: NotificationListener | null;\n  #statusRequestTimer: NodeJS.Timeout | null;\n  #statusRequestController: AbortController | null;\n  #syncMaster: string | null;\n  #serverType: ServerType;\n  #pollingInterval: NodeJS.Timeout | null;\n\n  constructor(player: Player, serverCredentials: ServerCredentials) {\n    super();\n    this.#player = player;\n    this.#serverCredentials = serverCredentials;\n    this.#notificationListener = null;\n    this.#statusRequestTimer = null;\n    this.#statusRequestController = null;\n    this.#syncMaster = null;\n    this.#serverType = 'unknown';\n    this.#pollingInterval = null;\n  }\n\n  async start() {\n    // Detect server type first\n    this.#serverType = await this.#detectServerType();\n    sm.getLogger().info(`[squeezelite_mc] Detected server type: ${this.#serverType}`);\n\n    if (this.#serverType === 'music-assistant') {\n      // Use polling for Music Assistant\n      this.#startPolling();\n    } else {\n      // Use subscription for LMS\n      this.#notificationListener = await this.#createAndStartNotificationListener();\n    }\n    \n    this.#syncMaster = (await this.#getPlayerSyncMaster()).syncMaster;\n    if (this.#syncMaster) {\n      sm.getLogger().info(`[squeezelite_mc] Squeezelite in sync group with sync master ${this.#syncMaster}.`);\n    }\n    await this.#getStatusAndEmit();\n  }\n\n  async stop() {\n    if (this.#notificationListener) {\n      await this.#notificationListener.stop();\n      this.#notificationListener = null;\n    }\n    if (this.#pollingInterval) {\n      clearInterval(this.#pollingInterval);\n      this.#pollingInterval = null;\n    }\n  }\n\n  getPlayer() {\n    return this.#player;\n  }\n\n  requestUpdate() {\n    this.#getStatusAndEmit()\n      .catch((error: unknown) => {\n        this.#stdLogError('#getStatusAndEmit()', error);\n      });\n  }\n\n  #stdLogError(fn: string, error: unknown, stack = false) {\n    sm.getLogger().error(sm.getErrorMessage(`[squeezelite_mc] Caught error in ${fn}:`, error, stack));\n  }\n\n  async #detectServerType(): Promise<ServerType> {\n    try {\n      const connectParams = getServerConnectParams(this.#player.server, this.#serverCredentials, 'rpc');\n      \n      // Check server status for UUID to identify Music Assistant\n      const serverStatusResult = await sendRpcRequest(connectParams, ['', ['serverstatus']]);\n      const uuid = serverStatusResult.result.uuid;\n      \n      if (uuid === 'aioslimproto') {\n        return 'music-assistant';\n      }\n      \n      // If UUID is not aioslimproto, assume it's LMS\n      return 'lms';\n    } catch (error) {\n      sm.getLogger().warn(`[squeezelite_mc] Could not detect server type: ${String(error)}. Defaulting to LMS.`);\n      return 'lms';\n    }\n  }\n\n  #startPolling() {\n    sm.getLogger().info('[squeezelite_mc] Starting polling mode for Music Assistant server');\n    \n    // Poll every 1000ms (1 second)\n    this.#pollingInterval = setInterval(() => {\n      this.#getStatusAndEmit().catch((error: unknown) => {\n        this.#stdLogError('#getStatusAndEmit() [polling]', error);\n      });\n    }, 1000);\n    \n    // Initial status request\n    this.#getStatusAndEmit().catch((error: unknown) => {\n      this.#stdLogError('#getStatusAndEmit() [initial polling]', error);\n    });\n  }\n\n  #handleDisconnect() {\n    if (this.#notificationListener) {\n      this.#notificationListener.removeAllListeners('notification');\n      this.#notificationListener.removeAllListeners('disconnect');\n      this.#notificationListener = null;\n    }\n    \n    if (this.#pollingInterval) {\n      clearInterval(this.#pollingInterval);\n      this.#pollingInterval = null;\n    }\n    \n    this.#abortCurrentAndPendingStatusRequest();\n    this.emit('disconnect', this.#player);\n  }\n\n  #handleNotification(data: Notification) {\n    let preRequestStatus = Promise.resolve();\n    if (data.notification === 'sync') {\n      if (data.params[0] === '-') {\n        if (data.playerId === this.#player.id) { // Unsynced\n          sm.getLogger().info('[squeezelite_mc] Squeezelite removed from sync group.');\n          this.#syncMaster = null;\n        }\n        else if (data.playerId === this.#syncMaster) { // Sync master itself unsynced\n          sm.getLogger().info(`[squeezelite_mc] Squeezelite's sync master (${this.#syncMaster}) removed from sync group.`);\n          // Need to get updated sync master, if any.\n          preRequestStatus = this.#getPlayerSyncMaster().then((result) => {\n            if (result.syncMaster) {\n              sm.getLogger().info(`[squeezelite_mc] Squeezelite is now in sync group with sync master ${result.syncMaster}.`);\n            }\n            else if (!result.error) {\n              sm.getLogger().info('[squeezelite_mc] Squeezelite is now unsynced or in a sync group with itself as the sync master.');\n            }\n            this.#syncMaster = result.syncMaster;\n          });\n        }\n      }\n      else if (data.playerId && data.params[0] === this.#player.id) { // Synced\n        this.#syncMaster = data.playerId;\n        sm.getLogger().info(`[squeezelite_mc] Squeezelite joined sync group with sync master ${this.#syncMaster}.`);\n      }\n    }\n    if (data.playerId === this.#player.id || data.notification === 'sync' ||\n      (this.#syncMaster && data.playerId === this.#syncMaster)) {\n      this.#abortCurrentAndPendingStatusRequest();\n      preRequestStatus\n        .catch((error: unknown) => {\n          this.#stdLogError('preRequestStatus', error);\n        })\n        .finally(() => {\n          this.#abortCurrentAndPendingStatusRequest();\n          this.#statusRequestTimer = setTimeout(() => {\n            this.#getStatusAndEmit()\n              .catch((error: unknown) => {\n                this.#stdLogError('#getStatusAndEmit()', error);\n              });\n          }, 200);\n        });\n    }\n  }\n\n  async #getStatusAndEmit() {\n    this.#abortCurrentAndPendingStatusRequest();\n    this.#statusRequestController = new AbortController();\n\n    const playerStatus = await this.#requestPlayerStatus(this.#statusRequestController);\n    if (playerStatus._requestAborted !== undefined && playerStatus._requestAborted) {\n      return;\n    }\n    this.emit('update', {\n      player: this.#player,\n      status: this.#parsePlayerStatusResult(playerStatus.result)\n    });\n  }\n\n  #abortCurrentAndPendingStatusRequest() {\n    if (this.#statusRequestTimer) {\n      clearTimeout(this.#statusRequestTimer);\n      this.#statusRequestTimer = null;\n    }\n    if (this.#statusRequestController) {\n      this.#statusRequestController.abort();\n      this.#statusRequestController = null;\n    }\n  }\n\n  async #createAndStartNotificationListener() {\n    if (this.#serverType === 'music-assistant') {\n      throw new Error('Notification listener should not be used with Music Assistant');\n    }\n    \n    const notificationListener = new NotificationListener({\n      server: getServerConnectParams(this.#player.server, this.#serverCredentials, 'cli'),\n      subscribe: [ 'play', 'stop', 'pause', 'playlist', 'mixer', 'sync' ]\n    });\n    notificationListener.on('notification', this.#handleNotification.bind(this));\n    notificationListener.on('disconnect', this.#handleDisconnect.bind(this));\n    await notificationListener.start();\n    return notificationListener;\n  }\n\n  async #requestPlayerStatus(abortController: AbortController) {\n    const connectParams = getServerConnectParams(this.#player.server, this.#serverCredentials, 'rpc');\n    return sendRpcRequest(connectParams, [\n      this.#player.id,\n      [\n        'status',\n        '-',\n        1,\n        'tags:cgAABbehldiqtyrTISSuoKLNJj'\n      ]\n    ], abortController);\n  }\n\n  // If player is in a sync group, then get the master player of the group.\n  // Returns null if player is not in a sync group or it is the master player itself.\n  async #getPlayerSyncMaster() {\n    const connectParams = getServerConnectParams(this.#player.server, this.#serverCredentials, 'rpc');\n    try {\n      const status = await sendRpcRequest(connectParams, [\n        this.#player.id,\n        [\n          'status'\n        ]\n      ]);\n      return {\n        syncMaster: status.result.sync_master !== this.#player.id ? status.result.sync_master : null\n      };\n    }\n    catch (error) {\n      sm.getLogger().error(sm.getErrorMessage('[squeezelite_mc] Error in getting Squeezelite\\'s sync master: ', error));\n      return {\n        error: error\n      };\n    }\n  }\n\n  #parsePlayerStatusResult(data: any) {\n    const result: PlayerStatus = {\n      mode: data.mode,\n      time: data.time,\n      volume: data['mixer volume'],\n      repeatMode: data['playlist repeat'],\n      shuffleMode: data['playlist shuffle'],\n      canSeek: data['can_seek']\n    };\n\n    const track = data.playlist_loop?.[0];\n    if (track) {\n      result.currentTrack = {\n        type: track.type,\n        title: track.title,\n        artist: track.artist,\n        trackArtist: track.trackartist,\n        albumArtist: track.albumartist,\n        album: track.album,\n        remoteTitle: track.remote_title,\n        artworkUrl: track.artwork_url,\n        coverArt: track.coverart,\n        duration: track.duration,\n        sampleRate: track.samplerate,\n        sampleSize: track.samplesize,\n        bitrate: track.bitrate\n      };\n    }\n\n    return result;\n  }\n\n  on(event: 'update', listener: (data: {player: Player; status: PlayerStatus}) => void): this;\n  on(event: 'disconnect', listener: (player: Player) => void): this;\n  on(event: string | symbol, listener: (...args: any[]) => void): this {\n    return super.on(event, listener);\n  }\n}\n"]}