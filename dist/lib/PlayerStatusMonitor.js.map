{"version":3,"file":"PlayerStatusMonitor.js","sourceRoot":"","sources":["../../src/lib/PlayerStatusMonitor.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;AAAA,oDAAkC;AAClC,kFAAwC;AACxC,iEAA2E;AAG3E,iCAAgD;AAChD,+BAAuC;AACvC,iEAAwD;AAExD,MAAqB,mBAAoB,SAAQ,gBAAY;IAW3D,YAAY,MAAc,EAAE,iBAAoC;QAC9D,KAAK,EAAE,CAAC;;QAXV,8CAAgB;QAChB,yDAAsC;QACtC,4DAAmD;QACnD,0DAA2C;QAC3C,+DAAiD;QACjD,kDAA2B;QAC3B,wDAA2B;QAC3B,uDAAwC;QACxC,yDAA2B;QAIzB,uBAAA,IAAI,+BAAW,MAAM,MAAA,CAAC;QACtB,uBAAA,IAAI,0CAAsB,iBAAiB,MAAA,CAAC;QAC5C,uBAAA,IAAI,6CAAyB,IAAI,MAAA,CAAC;QAClC,uBAAA,IAAI,2CAAuB,IAAI,MAAA,CAAC;QAChC,uBAAA,IAAI,gDAA4B,IAAI,MAAA,CAAC;QACrC,uBAAA,IAAI,mCAAe,IAAI,MAAA,CAAC;QACxB,uBAAA,IAAI,yCAAqB,KAAK,MAAA,CAAC;QAC/B,uBAAA,IAAI,wCAAoB,IAAI,MAAA,CAAC;QAC7B,uBAAA,IAAI,0CAAsB,IAAI,MAAA,CAAC,CAAC,0CAA0C;IAC5E,CAAC;IAED,KAAK,CAAC,KAAK;QACT,sCAAsC;QACtC,uBAAA,IAAI,yCAAqB,MAAM,uBAAA,IAAI,iFAAsB,MAA1B,IAAI,CAAwB,MAAA,CAAC;QAE5D,IAAI,uBAAA,IAAI,6CAAkB,EAAE;YAC1B,8BAAE,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,qGAAqG,CAAC,CAAC;YAC3H,oCAAoC;YACpC,uBAAA,IAAI,yEAAc,MAAlB,IAAI,CAAgB,CAAC;SACtB;aACI;YACH,6CAA6C;YAC7C,IAAI;gBACF,uBAAA,IAAI,6CAAyB,MAAM,uBAAA,IAAI,+FAAoC,MAAxC,IAAI,CAAsC,MAAA,CAAC;aAC/E;YACD,OAAO,KAAK,EAAE;gBACZ,8BAAE,CAAC,SAAS,EAAE,CAAC,KAAK,CAAC,8BAAE,CAAC,eAAe,CAAC,wFAAwF,EAAE,KAAK,CAAC,CAAC,CAAC;gBAC1I,oGAAoG;gBACpG,uBAAA,IAAI,yCAAqB,IAAI,MAAA,CAAC;gBAC9B,uBAAA,IAAI,yEAAc,MAAlB,IAAI,CAAgB,CAAC;aACtB;SACF;QAED,uBAAA,IAAI,mCAAe,CAAC,MAAM,uBAAA,IAAI,gFAAqB,MAAzB,IAAI,CAAuB,CAAC,CAAC,UAAU,MAAA,CAAC;QAClE,IAAI,uBAAA,IAAI,uCAAY,EAAE;YACpB,8BAAE,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,+DAA+D,uBAAA,IAAI,uCAAY,GAAG,CAAC,CAAC;SACzG;QACD,MAAM,uBAAA,IAAI,6EAAkB,MAAtB,IAAI,CAAoB,CAAC;IACjC,CAAC;IAED,KAAK,CAAC,IAAI;QACR,IAAI,uBAAA,IAAI,iDAAsB,EAAE;YAC9B,MAAM,uBAAA,IAAI,iDAAsB,CAAC,IAAI,EAAE,CAAC;SACzC;QACD,IAAI,uBAAA,IAAI,4CAAiB,EAAE;YACzB,aAAa,CAAC,uBAAA,IAAI,4CAAiB,CAAC,CAAC;YACrC,uBAAA,IAAI,wCAAoB,IAAI,MAAA,CAAC;SAC9B;IACH,CAAC;IAED,SAAS;QACP,OAAO,uBAAA,IAAI,mCAAQ,CAAC;IACtB,CAAC;IAED,aAAa;QACX,uBAAA,IAAI,6EAAkB,MAAtB,IAAI,CAAoB,CAAC;IAC3B,CAAC;IA4PD,EAAE,CAAC,KAAsB,EAAE,QAAkC;QAC3D,OAAO,KAAK,CAAC,EAAE,CAAC,KAAK,EAAE,QAAQ,CAAC,CAAC;IACnC,CAAC;CACF;AApUD,sCAoUC;;IA5PG,IAAI,CAAC,uBAAA,IAAI,iDAAsB,EAAE;QAC/B,OAAO;KACR;IACD,uBAAA,IAAI,iDAAsB,CAAC,kBAAkB,CAAC,cAAc,CAAC,CAAC;IAC9D,uBAAA,IAAI,iDAAsB,CAAC,kBAAkB,CAAC,YAAY,CAAC,CAAC;IAC5D,uBAAA,IAAI,6CAAyB,IAAI,MAAA,CAAC;IAClC,uBAAA,IAAI,gGAAqC,MAAzC,IAAI,CAAuC,CAAC;IAE5C,IAAI,CAAC,IAAI,CAAC,YAAY,EAAE,uBAAA,IAAI,mCAAQ,CAAC,CAAC;AACxC,CAAC,6FAEmB,IAAkB;IACpC,IAAI,gBAAgB,GAAG,OAAO,CAAC,OAAO,EAAE,CAAC;IACzC,IAAI,IAAI,CAAC,YAAY,KAAK,MAAM,EAAE;QAChC,IAAI,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,KAAK,GAAG,EAAE;YAC1B,IAAI,IAAI,CAAC,QAAQ,KAAK,uBAAA,IAAI,mCAAQ,CAAC,EAAE,EAAE,EAAE,WAAW;gBAClD,8BAAE,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,uDAAuD,CAAC,CAAC;gBAC7E,uBAAA,IAAI,mCAAe,IAAI,MAAA,CAAC;aACzB;iBACI,IAAI,IAAI,CAAC,QAAQ,KAAK,uBAAA,IAAI,uCAAY,EAAE,EAAE,8BAA8B;gBAC3E,8BAAE,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,+CAA+C,uBAAA,IAAI,uCAAY,4BAA4B,CAAC,CAAC;gBACjH,2CAA2C;gBAC3C,gBAAgB,GAAG,uBAAA,IAAI,gFAAqB,MAAzB,IAAI,CAAuB,CAAC,IAAI,CAAC,CAAC,MAAM,EAAE,EAAE;oBAC7D,IAAI,MAAM,CAAC,UAAU,EAAE;wBACrB,8BAAE,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,sEAAsE,MAAM,CAAC,UAAU,GAAG,CAAC,CAAC;qBACjH;yBACI,IAAI,CAAC,MAAM,CAAC,KAAK,EAAE;wBACtB,8BAAE,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,iGAAiG,CAAC,CAAC;qBACxH;oBACD,uBAAA,IAAI,mCAAe,MAAM,CAAC,UAAU,MAAA,CAAC;gBACvC,CAAC,CAAC,CAAC;aACJ;SACF;aACI,IAAI,IAAI,CAAC,QAAQ,IAAI,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,KAAK,uBAAA,IAAI,mCAAQ,CAAC,EAAE,EAAE,EAAE,SAAS;YACvE,uBAAA,IAAI,mCAAe,IAAI,CAAC,QAAQ,MAAA,CAAC;YACjC,8BAAE,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,mEAAmE,uBAAA,IAAI,uCAAY,GAAG,CAAC,CAAC;SAC7G;KACF;IACD,IAAI,IAAI,CAAC,QAAQ,KAAK,uBAAA,IAAI,mCAAQ,CAAC,EAAE,IAAI,IAAI,CAAC,YAAY,KAAK,MAAM;QACnE,CAAC,uBAAA,IAAI,uCAAY,IAAI,IAAI,CAAC,QAAQ,KAAK,uBAAA,IAAI,uCAAY,CAAC,EAAE;QAC1D,uBAAA,IAAI,gGAAqC,MAAzC,IAAI,CAAuC,CAAC;QAC5C,gBAAgB,CAAC,OAAO,CAAC,GAAG,EAAE;YAC5B,uBAAA,IAAI,gGAAqC,MAAzC,IAAI,CAAuC,CAAC;YAC5C,uBAAA,IAAI,2CAAuB,UAAU,CAAC,uBAAA,IAAI,6EAAkB,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE,GAAG,CAAC,MAAA,CAAC;QAChF,CAAC,CAAC,CAAC;KACJ;AACH,CAAC,0CAED,KAAK;IACH,uBAAA,IAAI,gGAAqC,MAAzC,IAAI,CAAuC,CAAC;IAC5C,uBAAA,IAAI,gDAA4B,IAAI,uCAAe,EAAE,MAAA,CAAC;IAEtD,IAAI;QACF,MAAM,YAAY,GAAG,MAAM,uBAAA,IAAI,gFAAqB,MAAzB,IAAI,EAAsB,uBAAA,IAAI,oDAAyB,CAAC,CAAC;QACpF,IAAI,YAAY,CAAC,eAAe,KAAK,SAAS,IAAI,YAAY,CAAC,eAAe,EAAE;YAC9E,OAAO;SACR;QAED,iCAAiC;QACjC,IAAI,CAAC,YAAY,CAAC,MAAM,EAAE;YACxB,8BAAE,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,4DAA4D,CAAC,CAAC;YAClF,OAAO;SACR;QAED,4EAA4E;QAC5E,gFAAgF;QAChF,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE;YAClB,MAAM,EAAE,uBAAA,IAAI,mCAAQ;YACpB,MAAM,EAAE,uBAAA,IAAI,oFAAyB,MAA7B,IAAI,EAA0B,YAAY,CAAC,MAAM,CAAC;SAC3D,CAAC,CAAC;KACJ;IACD,OAAO,KAAK,EAAE;QACZ,8BAAE,CAAC,SAAS,EAAE,CAAC,KAAK,CAAC,8BAAE,CAAC,eAAe,CAAC,gDAAgD,EAAE,KAAK,CAAC,CAAC,CAAC;KACnG;AACH,CAAC;IAGC,IAAI,uBAAA,IAAI,+CAAoB,EAAE;QAC5B,YAAY,CAAC,uBAAA,IAAI,+CAAoB,CAAC,CAAC;QACvC,uBAAA,IAAI,2CAAuB,IAAI,MAAA,CAAC;KACjC;IACD,IAAI,uBAAA,IAAI,oDAAyB,EAAE;QACjC,uBAAA,IAAI,oDAAyB,CAAC,KAAK,EAAE,CAAC;QACtC,uBAAA,IAAI,gDAA4B,IAAI,MAAA,CAAC;KACtC;AACH,CAAC,4DAED,KAAK;IACH,MAAM,oBAAoB,GAAG,IAAI,4CAAoB,CAAC;QACpD,MAAM,EAAE,IAAA,6BAAsB,EAAC,uBAAA,IAAI,mCAAQ,CAAC,MAAM,EAAE,uBAAA,IAAI,8CAAmB,EAAE,KAAK,CAAC;QACnF,SAAS,EAAE,CAAE,MAAM,EAAE,MAAM,EAAE,OAAO,EAAE,UAAU,EAAE,OAAO,EAAE,MAAM,CAAE;KACpE,CAAC,CAAC;IACH,oBAAoB,CAAC,EAAE,CAAC,cAAc,EAAE,uBAAA,IAAI,+EAAoB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;IAC7E,oBAAoB,CAAC,EAAE,CAAC,YAAY,EAAE,uBAAA,IAAI,6EAAkB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;IACzE,MAAM,oBAAoB,CAAC,KAAK,EAAE,CAAC;IACnC,OAAO,oBAAoB,CAAC;AAC9B,CAAC,8CAED,KAAK;IACH,MAAM,aAAa,GAAG,IAAA,6BAAsB,EAAC,uBAAA,IAAI,mCAAQ,CAAC,MAAM,EAAE,uBAAA,IAAI,8CAAmB,EAAE,KAAK,CAAC,CAAC;IAElG,wDAAwD;IACxD,MAAM,UAAU,GAAG,CAAC,CAAC;IACrB,MAAM,UAAU,GAAG,IAAI,CAAC,CAAC,WAAW;IAEpC,KAAK,IAAI,OAAO,GAAG,CAAC,EAAE,OAAO,IAAI,UAAU,EAAE,OAAO,EAAE,EAAE;QACtD,IAAI;YACF,MAAM,UAAU,GAAG,IAAI,uCAAe,EAAE,CAAC;YACzC,MAAM,SAAS,GAAG,UAAU,CAAC,GAAG,EAAE,CAAC,UAAU,CAAC,KAAK,EAAE,EAAE,IAAI,CAAC,CAAC,CAAC,mBAAmB;YAEjF,MAAM,QAAQ,GAAG,MAAM,IAAA,oBAAc,EAAC,aAAa,EAAE;gBACnD,EAAE;gBACF,CAAE,cAAc,CAAE;aACnB,EAAE,UAAU,CAAC,CAAC;YAEf,YAAY,CAAC,SAAS,CAAC,CAAC;YAExB,IAAI,QAAQ,CAAC,MAAM,IAAI,QAAQ,CAAC,MAAM,CAAC,IAAI,KAAK,cAAc,EAAE;gBAC9D,8BAAE,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,uDAAuD,CAAC,CAAC;gBAC7E,OAAO,IAAI,CAAC;aACb;YACD,8BAAE,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,oDAAoD,CAAC,CAAC;YAC1E,OAAO,KAAK,CAAC;SACd;QACD,OAAO,KAAK,EAAE;YACZ,IAAI,OAAO,GAAG,UAAU,EAAE;gBACxB,8BAAE,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,yDAAyD,OAAO,IAAI,UAAU,gBAAgB,CAAC,CAAC;gBACpH,MAAM,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC,UAAU,CAAC,OAAO,EAAE,UAAU,CAAC,CAAC,CAAC;aACjE;iBACI;gBACH,8BAAE,CAAC,SAAS,EAAE,CAAC,KAAK,CAAC,8BAAE,CAAC,eAAe,CAAC,wEAAwE,EAAE,KAAK,CAAC,CAAC,CAAC;gBAC1H,4CAA4C;gBAC5C,OAAO,KAAK,CAAC;aACd;SACF;KACF;IACD,OAAO,KAAK,CAAC;AACf,CAAC;IAGC,IAAI,uBAAA,IAAI,4CAAiB,EAAE;QACzB,aAAa,CAAC,uBAAA,IAAI,4CAAiB,CAAC,CAAC;KACtC;IACD,uBAAA,IAAI,wCAAoB,WAAW,CAAC,KAAK,IAAI,EAAE;QAC7C,IAAI;YACF,2DAA2D;YAC3D,MAAM,UAAU,GAAG,MAAM,uBAAA,IAAI,gFAAqB,MAAzB,IAAI,CAAuB,CAAC;YACrD,IAAI,UAAU,CAAC,UAAU,KAAK,uBAAA,IAAI,uCAAY,EAAE;gBAC9C,IAAI,UAAU,CAAC,UAAU,EAAE;oBACzB,8BAAE,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,uDAAuD,UAAU,CAAC,UAAU,GAAG,CAAC,CAAC;iBACtG;qBACI,IAAI,uBAAA,IAAI,uCAAY,EAAE;oBACzB,8BAAE,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,uDAAuD,CAAC,CAAC;iBAC9E;gBACD,uBAAA,IAAI,mCAAe,UAAU,CAAC,UAAU,MAAA,CAAC;aAC1C;YACD,MAAM,uBAAA,IAAI,6EAAkB,MAAtB,IAAI,CAAoB,CAAC;SAChC;QACD,OAAO,KAAK,EAAE;YACZ,8BAAE,CAAC,SAAS,EAAE,CAAC,KAAK,CAAC,8BAAE,CAAC,eAAe,CAAC,0CAA0C,EAAE,KAAK,CAAC,CAAC,CAAC;SAC7F;IACH,CAAC,EAAE,uBAAA,IAAI,8CAAmB,CAAC,MAAA,CAAC;AAC9B,CAAC,6CAED,KAAK,mDAAsB,eAAgC;IACzD,MAAM,aAAa,GAAG,IAAA,6BAAsB,EAAC,uBAAA,IAAI,mCAAQ,CAAC,MAAM,EAAE,uBAAA,IAAI,8CAAmB,EAAE,KAAK,CAAC,CAAC;IAClG,OAAO,IAAA,oBAAc,EAAC,aAAa,EAAE;QACnC,uBAAA,IAAI,mCAAQ,CAAC,EAAE;QACf;YACE,QAAQ;YACR,GAAG;YACH,CAAC;YACD,iCAAiC;SAClC;KACF,EAAE,eAAe,CAAC,CAAC;AACtB,CAAC;AAED,yEAAyE;AACzE,mFAAmF;AACnF,KAAK;IACH,MAAM,aAAa,GAAG,IAAA,6BAAsB,EAAC,uBAAA,IAAI,mCAAQ,CAAC,MAAM,EAAE,uBAAA,IAAI,8CAAmB,EAAE,KAAK,CAAC,CAAC;IAClG,IAAI;QACF,MAAM,MAAM,GAAG,MAAM,IAAA,oBAAc,EAAC,aAAa,EAAE;YACjD,uBAAA,IAAI,mCAAQ,CAAC,EAAE;YACf;gBACE,QAAQ;aACT;SACF,CAAC,CAAC;QACH,OAAO;YACL,UAAU,EAAE,MAAM,CAAC,MAAM,CAAC,WAAW,KAAK,uBAAA,IAAI,mCAAQ,CAAC,EAAE,CAAC,CAAC,CAAC,MAAM,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC,CAAC,IAAI;SAC7F,CAAC;KACH;IACD,OAAO,KAAK,EAAE;QACZ,8BAAE,CAAC,SAAS,EAAE,CAAC,KAAK,CAAC,8BAAE,CAAC,eAAe,CAAC,gEAAgE,EAAE,KAAK,CAAC,CAAC,CAAC;QAClH,OAAO;YACL,KAAK,EAAE,KAAK;SACb,CAAC;KACH;AACH,CAAC,uGAEwB,IAAS;IAChC,IAAI,CAAC,IAAI,EAAE;QACT,8BAAE,CAAC,SAAS,EAAE,CAAC,IAAI,CAAC,6EAA6E,CAAC,CAAC;QACnG,OAAO;YACL,IAAI,EAAE,MAAM;YACZ,IAAI,EAAE,CAAC;YACP,MAAM,EAAE,CAAC;YACT,UAAU,EAAE,CAAC;YACb,WAAW,EAAE,CAAC;YACd,OAAO,EAAE,CAAC;SACK,CAAC;KACnB;IAED,MAAM,MAAM,GAAiB;QAC3B,IAAI,EAAE,IAAI,CAAC,IAAI,IAAI,MAAM;QACzB,IAAI,EAAE,IAAI,CAAC,IAAI;QACf,MAAM,EAAE,IAAI,CAAC,cAAc,CAAC;QAC5B,UAAU,EAAE,IAAI,CAAC,iBAAiB,CAAC;QACnC,WAAW,EAAE,IAAI,CAAC,kBAAkB,CAAC;QACrC,OAAO,EAAE,IAAI,CAAC,UAAU,CAAC;KAC1B,CAAC;IAEF,uDAAuD;IACvD,IAAI,IAAI,CAAC,aAAa,IAAI,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,aAAa,CAAC,IAAI,IAAI,CAAC,aAAa,CAAC,MAAM,GAAG,CAAC,EAAE;QAC5F,MAAM,KAAK,GAAG,IAAI,CAAC,aAAa,CAAC,CAAC,CAAC,CAAC;QACpC,IAAI,KAAK,EAAE;YACT,MAAM,CAAC,YAAY,GAAG;gBACpB,IAAI,EAAE,KAAK,CAAC,IAAI;gBAChB,KAAK,EAAE,KAAK,CAAC,KAAK;gBAClB,MAAM,EAAE,KAAK,CAAC,MAAM;gBACpB,WAAW,EAAE,KAAK,CAAC,WAAW;gBAC9B,WAAW,EAAE,KAAK,CAAC,WAAW;gBAC9B,KAAK,EAAE,KAAK,CAAC,KAAK;gBAClB,WAAW,EAAE,KAAK,CAAC,YAAY;gBAC/B,UAAU,EAAE,KAAK,CAAC,WAAW;gBAC7B,QAAQ,EAAE,KAAK,CAAC,QAAQ;gBACxB,QAAQ,EAAE,KAAK,CAAC,QAAQ;gBACxB,UAAU,EAAE,KAAK,CAAC,UAAU;gBAC5B,UAAU,EAAE,KAAK,CAAC,UAAU;gBAC5B,OAAO,EAAE,KAAK,CAAC,OAAO;aACvB,CAAC;SACH;KACF;IAED,OAAO,MAAM,CAAC;AAChB,CAAC","sourcesContent":["import EventEmitter from 'events';\nimport sm from './SqueezeliteMCContext';\nimport { Notification, NotificationListener } from 'lms-cli-notifications';\nimport Player, { PlayerStatus } from './types/Player';\nimport { ServerCredentials } from './types/Server';\nimport { getServerConnectParams } from './Util';\nimport { sendRpcRequest } from './RPC';\nimport { AbortController } from 'node-abort-controller';\n\nexport default class PlayerStatusMonitor extends EventEmitter {\n  #player: Player;\n  #serverCredentials: ServerCredentials;\n  #notificationListener: NotificationListener | null;\n  #statusRequestTimer: NodeJS.Timeout | null;\n  #statusRequestController: AbortController | null;\n  #syncMaster: string | null;\n  #isMusicAssistant: boolean;\n  #pollingInterval: NodeJS.Timeout | null;\n  #pollingIntervalMs: number;\n\n  constructor(player: Player, serverCredentials: ServerCredentials) {\n    super();\n    this.#player = player;\n    this.#serverCredentials = serverCredentials;\n    this.#notificationListener = null;\n    this.#statusRequestTimer = null;\n    this.#statusRequestController = null;\n    this.#syncMaster = null;\n    this.#isMusicAssistant = false;\n    this.#pollingInterval = null;\n    this.#pollingIntervalMs = 1000; // Poll every 1 second for Music Assistant\n  }\n\n  async start() {\n    // Detect if server is Music Assistant\n    this.#isMusicAssistant = await this.#detectMusicAssistant();\n\n    if (this.#isMusicAssistant) {\n      sm.getLogger().info('[squeezelite_mc] Music Assistant server detected. Using polling mode instead of event subscription.');\n      // Start polling for Music Assistant\n      this.#startPolling();\n    }\n    else {\n      // Use notification listener for standard LMS\n      try {\n        this.#notificationListener = await this.#createAndStartNotificationListener();\n      }\n      catch (error) {\n        sm.getLogger().error(sm.getErrorMessage('[squeezelite_mc] Failed to start notification listener, falling back to polling mode: ', error));\n        // Fall back to polling if notification listener fails (e.g., Music Assistant not detected properly)\n        this.#isMusicAssistant = true;\n        this.#startPolling();\n      }\n    }\n\n    this.#syncMaster = (await this.#getPlayerSyncMaster()).syncMaster;\n    if (this.#syncMaster) {\n      sm.getLogger().info(`[squeezelite_mc] Squeezelite in sync group with sync master ${this.#syncMaster}.`);\n    }\n    await this.#getStatusAndEmit();\n  }\n\n  async stop() {\n    if (this.#notificationListener) {\n      await this.#notificationListener.stop();\n    }\n    if (this.#pollingInterval) {\n      clearInterval(this.#pollingInterval);\n      this.#pollingInterval = null;\n    }\n  }\n\n  getPlayer() {\n    return this.#player;\n  }\n\n  requestUpdate() {\n    this.#getStatusAndEmit();\n  }\n\n  #handleDisconnect() {\n    if (!this.#notificationListener) {\n      return;\n    }\n    this.#notificationListener.removeAllListeners('notification');\n    this.#notificationListener.removeAllListeners('disconnect');\n    this.#notificationListener = null;\n    this.#abortCurrentAndPendingStatusRequest();\n\n    this.emit('disconnect', this.#player);\n  }\n\n  #handleNotification(data: Notification) {\n    let preRequestStatus = Promise.resolve();\n    if (data.notification === 'sync') {\n      if (data.params[0] === '-') {\n        if (data.playerId === this.#player.id) { // Unsynced\n          sm.getLogger().info('[squeezelite_mc] Squeezelite removed from sync group.');\n          this.#syncMaster = null;\n        }\n        else if (data.playerId === this.#syncMaster) { // Sync master itself unsynced\n          sm.getLogger().info(`[squeezelite_mc] Squeezelite's sync master (${this.#syncMaster}) removed from sync group.`);\n          // Need to get updated sync master, if any.\n          preRequestStatus = this.#getPlayerSyncMaster().then((result) => {\n            if (result.syncMaster) {\n              sm.getLogger().info(`[squeezelite_mc] Squeezelite is now in sync group with sync master ${result.syncMaster}.`);\n            }\n            else if (!result.error) {\n              sm.getLogger().info('[squeezelite_mc] Squeezelite is now unsynced or in a sync group with itself as the sync master.');\n            }\n            this.#syncMaster = result.syncMaster;\n          });\n        }\n      }\n      else if (data.playerId && data.params[0] === this.#player.id) { // Synced\n        this.#syncMaster = data.playerId;\n        sm.getLogger().info(`[squeezelite_mc] Squeezelite joined sync group with sync master ${this.#syncMaster}.`);\n      }\n    }\n    if (data.playerId === this.#player.id || data.notification === 'sync' ||\n      (this.#syncMaster && data.playerId === this.#syncMaster)) {\n      this.#abortCurrentAndPendingStatusRequest();\n      preRequestStatus.finally(() => {\n        this.#abortCurrentAndPendingStatusRequest();\n        this.#statusRequestTimer = setTimeout(this.#getStatusAndEmit.bind(this), 200);\n      });\n    }\n  }\n\n  async #getStatusAndEmit() {\n    this.#abortCurrentAndPendingStatusRequest();\n    this.#statusRequestController = new AbortController();\n\n    try {\n      const playerStatus = await this.#requestPlayerStatus(this.#statusRequestController);\n      if (playerStatus._requestAborted !== undefined && playerStatus._requestAborted) {\n        return;\n      }\n\n      // Check if we got a valid result\n      if (!playerStatus.result) {\n        sm.getLogger().warn('[squeezelite_mc] Player status request returned no result.');\n        return;\n      }\n\n      // For Music Assistant, ensure we parse the result even when in a sync group\n      // The status command should return the correct information including sync state\n      this.emit('update', {\n        player: this.#player,\n        status: this.#parsePlayerStatusResult(playerStatus.result)\n      });\n    }\n    catch (error) {\n      sm.getLogger().error(sm.getErrorMessage('[squeezelite_mc] Error getting player status: ', error));\n    }\n  }\n\n  #abortCurrentAndPendingStatusRequest() {\n    if (this.#statusRequestTimer) {\n      clearTimeout(this.#statusRequestTimer);\n      this.#statusRequestTimer = null;\n    }\n    if (this.#statusRequestController) {\n      this.#statusRequestController.abort();\n      this.#statusRequestController = null;\n    }\n  }\n\n  async #createAndStartNotificationListener() {\n    const notificationListener = new NotificationListener({\n      server: getServerConnectParams(this.#player.server, this.#serverCredentials, 'cli'),\n      subscribe: [ 'play', 'stop', 'pause', 'playlist', 'mixer', 'sync' ]\n    });\n    notificationListener.on('notification', this.#handleNotification.bind(this));\n    notificationListener.on('disconnect', this.#handleDisconnect.bind(this));\n    await notificationListener.start();\n    return notificationListener;\n  }\n\n  async #detectMusicAssistant() {\n    const connectParams = getServerConnectParams(this.#player.server, this.#serverCredentials, 'rpc');\n\n    // Add timeout and retry logic for more robust detection\n    const maxRetries = 3;\n    const retryDelay = 1000; // 1 second\n\n    for (let attempt = 1; attempt <= maxRetries; attempt++) {\n      try {\n        const controller = new AbortController();\n        const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout\n\n        const response = await sendRpcRequest(connectParams, [\n          '',\n          [ 'serverstatus' ]\n        ], controller);\n\n        clearTimeout(timeoutId);\n\n        if (response.result && response.result.uuid === 'aioslimproto') {\n          sm.getLogger().info('[squeezelite_mc] Server identified as Music Assistant');\n          return true;\n        }\n        sm.getLogger().info('[squeezelite_mc] Server identified as standard LMS');\n        return false;\n      }\n      catch (error) {\n        if (attempt < maxRetries) {\n          sm.getLogger().warn(`[squeezelite_mc] Error detecting server type (attempt ${attempt}/${maxRetries}), retrying...`);\n          await new Promise((resolve) => setTimeout(resolve, retryDelay));\n        }\n        else {\n          sm.getLogger().error(sm.getErrorMessage('[squeezelite_mc] Error detecting server type after multiple attempts: ', error));\n          // Default to standard LMS behavior on error\n          return false;\n        }\n      }\n    }\n    return false;\n  }\n\n  #startPolling() {\n    if (this.#pollingInterval) {\n      clearInterval(this.#pollingInterval);\n    }\n    this.#pollingInterval = setInterval(async () => {\n      try {\n        // Check for sync master changes when using Music Assistant\n        const syncResult = await this.#getPlayerSyncMaster();\n        if (syncResult.syncMaster !== this.#syncMaster) {\n          if (syncResult.syncMaster) {\n            sm.getLogger().info(`[squeezelite_mc] Squeezelite sync master changed to ${syncResult.syncMaster}.`);\n          }\n          else if (this.#syncMaster) {\n            sm.getLogger().info('[squeezelite_mc] Squeezelite removed from sync group.');\n          }\n          this.#syncMaster = syncResult.syncMaster;\n        }\n        await this.#getStatusAndEmit();\n      }\n      catch (error) {\n        sm.getLogger().error(sm.getErrorMessage('[squeezelite_mc] Error in polling loop: ', error));\n      }\n    }, this.#pollingIntervalMs);\n  }\n\n  async #requestPlayerStatus(abortController: AbortController) {\n    const connectParams = getServerConnectParams(this.#player.server, this.#serverCredentials, 'rpc');\n    return sendRpcRequest(connectParams, [\n      this.#player.id,\n      [\n        'status',\n        '-',\n        1,\n        'tags:cgAABbehldiqtyrTISSuoKLNJj'\n      ]\n    ], abortController);\n  }\n\n  // If player is in a sync group, then get the master player of the group.\n  // Returns null if player is not in a sync group or it is the master player itself.\n  async #getPlayerSyncMaster() {\n    const connectParams = getServerConnectParams(this.#player.server, this.#serverCredentials, 'rpc');\n    try {\n      const status = await sendRpcRequest(connectParams, [\n        this.#player.id,\n        [\n          'status'\n        ]\n      ]);\n      return {\n        syncMaster: status.result.sync_master !== this.#player.id ? status.result.sync_master : null\n      };\n    }\n    catch (error) {\n      sm.getLogger().error(sm.getErrorMessage('[squeezelite_mc] Error in getting Squeezelite\\'s sync master: ', error));\n      return {\n        error: error\n      };\n    }\n  }\n\n  #parsePlayerStatusResult(data: any) {\n    if (!data) {\n      sm.getLogger().warn('[squeezelite_mc] Received null or undefined data in parsePlayerStatusResult');\n      return {\n        mode: 'stop',\n        time: 0,\n        volume: 0,\n        repeatMode: 0,\n        shuffleMode: 0,\n        canSeek: 0\n      } as PlayerStatus;\n    }\n\n    const result: PlayerStatus = {\n      mode: data.mode || 'stop',\n      time: data.time,\n      volume: data['mixer volume'],\n      repeatMode: data['playlist repeat'],\n      shuffleMode: data['playlist shuffle'],\n      canSeek: data['can_seek']\n    };\n\n    // Safely check for playlist_loop array and first track\n    if (data.playlist_loop && Array.isArray(data.playlist_loop) && data.playlist_loop.length > 0) {\n      const track = data.playlist_loop[0];\n      if (track) {\n        result.currentTrack = {\n          type: track.type,\n          title: track.title,\n          artist: track.artist,\n          trackArtist: track.trackartist,\n          albumArtist: track.albumartist,\n          album: track.album,\n          remoteTitle: track.remote_title,\n          artworkUrl: track.artwork_url,\n          coverArt: track.coverart,\n          duration: track.duration,\n          sampleRate: track.samplerate,\n          sampleSize: track.samplesize,\n          bitrate: track.bitrate\n        };\n      }\n    }\n\n    return result;\n  }\n\n  on(event: 'update', listener: (data: {player: Player; status: PlayerStatus}) => void): this;\n  on(event: 'disconnect', listener: (player: Player) => void): this;\n  on(event: string | symbol, listener: (...args: any[]) => void): this {\n    return super.on(event, listener);\n  }\n}\n"]}